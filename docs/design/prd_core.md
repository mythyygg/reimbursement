本文件包含核心需求与验收标准；UI/UX 与视觉规范见 `docs/prd_ui.md`。

---

# PRD：项目报销收纳与装订工具（方案 B：标准版 + 智能候选匹配）

## 0. 概要

**产品定位**：报销准备工具（Reimbursement Prep），用于“项目维度”集中记录垫付支出与票据材料，完成匹配核对并导出报销包。
**不做**传统记账（预算、账户体系、报表、资产管理等）。
**移动端优先**：Web/PWA（可添加到主屏幕），单手可用、现场录入快。

---

## 1. 背景与问题

目前用 iPhone 备忘录记录垫付（日期/支出/备注），票据截图散落在多个 App、相册与文件。报销时需要回溯截图并补齐材料，易出现：

- 找票慢、漏票
- 重复票据（同一张截图重复用）
- 票据金额/日期与支出不一致，导致退回
- 报销前整理耗时高

---

## 2. 产品目标与成功指标

### 2.1 目标

1. **现场录入接近备忘录速度**，且每笔支出必须挂在项目下。
2. **票据集中收纳**（项目内收纳箱），支持截图/文件/PDF，便于后续匹配。
3. **导出前自动生成问题清单**（缺票/重复/不一致），降低退回。
4. 通过**智能候选匹配**减少人工填字段与手动找票成本（必须人工确认）。

### 2.2 成功指标（上线后 4 周）

- 新增支出：熟练用户中位数 ≤ 6 秒，P90 ≤ 12 秒
- 票据入库到“可用状态”（归项目 + 建议可用）：中位数 ≤ 15 秒
- 导出前问题发现率（缺票/重复/不一致）：≥ 90%
- 用户主观：报销整理耗时下降 ≥ 50%

---

## 3. 范围（Scope）

### 3.1 In Scope（本期）

- 项目：创建/搜索/置顶/归档
- 支出：快速录入、编辑、筛选、状态管理（缺票/已关联/不需票）
- 票据收纳箱：上传（多选）、预览、去重提示
- 匹配：票据 ↔ 支出（人工确认）
- 智能候选匹配：按规则输出 Top 3 建议（人工确认）
- 批次：按日期/筛选创建 → 检查清单 → 导出 CSV + ZIP（可选 PDF 汇总页）
- 设置：类别、导出字段模板、匹配策略开关

### 3.2 Out of Scope（明确不做）

- 记账类：预算、报表、分账、账户体系
- 供应商/合同/开票信息管理
- 自动绑定票据（无人工确认）、绕过核对的逻辑

---

## 4. 用户画像与使用场景

**主用户**：艺宣/执行经纪，移动场景频繁，周期性集中报销。

**典型场景**

- 现场/路上：随手录支出（打车/餐饮/快递/物料）
- 拍摄/制作日：多笔集中录入，票据先丢收纳箱，晚些补匹配
- 报销前：按项目创建批次，清问题清单，导出上传

---

## 5. 核心业务规则（默认策略）

1. **每笔支出必须属于某项目**（入口默认上次项目）。
2. **票据可先归项目，再匹配支出**（适配截图来源分散）。
3. **匹配必须人工确认**（候选仅建议）。
4. **去重不拦截，只提示风险**（避免误伤：同商户同金额等）。
5. **金额不一致不拦截，但进入问题清单并要求备注说明**。
6. **默认匹配关系：1 张票据 → 1 笔支出**（降低重复/误用风险）。

   - 如未来需要“拆分/合并”，建议作为后续增强：进入“拆分模式”并强制备注说明。

---

## 6. 功能需求（Functional Requirements）

### 6.1 项目模块

- 创建项目：项目名/项目号（二选一必填）
- 项目列表：最近使用、置顶、搜索、归档入口
- 项目卡片摘要：缺票数、未导出支出数、最近更新日期
- 归档：隐藏已结束项目（仍可搜索/查看）

### 6.2 支出模块（项目内）

- 快速新增（单行输入 + 可选语音）

  - 必填：金额（合法数值）、备注（建议必填，可配置为强制）
  - 默认：日期=今天；类别可空；状态=缺票

- 支出列表

  - 排序：默认“缺票优先 + 日期倒序”（可切换为纯日期倒序）
  - 筛选：全部/缺票/已关联/不需票；类别；日期范围

- 支出详情（抽屉）

  - 编辑：日期、金额、类别、备注、状态
  - 附件：查看、添加、移除
  - 建议票据：显示 Top 3（若有）+ 一键确认绑定
  - 从收纳箱选择：手动搜索/筛选后确认绑定

### 6.3 票据收纳箱（项目内）

- 上传：相册多选、文件选择、分享至 PWA（如实现）
- 票据卡片：

  - 缩略图/预览
  - 去重提示（疑似重复）
  - 候选匹配（Top 3）+ 人工确认

- 操作：删除/归档（删除二次确认）、更换匹配、解除匹配

### 6.4 [已移除]


### 6.5 智能候选匹配（人工确认）

**目标**：减少在收纳箱中翻找与手动匹配成本。

- 候选生成规则（可配置）

  1. 同项目
  2. 日期接近（默认 ±3 天）
  3. 金额相同（默认容差 0；可选 0.01；不建议默认 ±1）
  4. 类别一致（若支出类别为空则不作为约束；票据类型未知也不强约束）

- 排序（建议权重）
  金额相同 > 日期更近 > 类别一致 > 备注关键词命中
- 呈现

  - Top 3 建议支出 + 置信度（高/中/低）
  - 点击“确认匹配”才绑定；可“忽略建议”

- 置信度定义（用于 UI 标签，不自动绑定）

  - 高：金额相同 + 日期 ≤1 天 +（类别一致或类别为空）
  - 中：金额相同 + 日期 ≤3 天
  - 低：金额在容差内或日期更远但关键词命中

### 6.6 批次与导出

- 创建批次

  - 日期范围（默认：上次导出后 → 今天）
  - 包含状态：默认“已关联”；缺票可选但标红警告

- 检查清单（必须）

  - 缺票支出（合计、笔数、按类别统计）
  - 疑似重复票据（hash 相同；可选增加相似度）
  - 金额不一致（当 OCR/手填金额存在时）
  - OCR 未识别/字段缺失（可选提醒）

- 导出物

  - CSV：条目清单（字段可配置）
  - ZIP：附件包（命名与 CSV 编号一致）
  - 可选 PDF：汇总索引页（编号 ↔ 附件名 ↔ 金额 ↔ 备注）

- 附件命名规则（默认）
  `序号_日期_金额_类别_备注前20字_票据ID.扩展名`

---

## 7. 非功能需求（Non-functional）

- 移动优先 PWA：可添加主屏幕；单手可用
- 性能：项目详情首屏 ≤ 2 秒（4G）；列表 1000 条可筛选不卡顿
- 可靠性：上传断网 → 本地队列重试；明确“未完成/待上传”状态
- 安全：登录鉴权；文件 URL 需签名或鉴权；删除二次确认；可选 7 天回收站
- OCR 技术约束：端侧/浏览器侧优先；服务端 OCR 需更强隐私说明与鉴权

---

## 8. 数据结构（Core Data Model）

### 8.1 Project

- project_id
- name（可空）/ code（可空，二选一必填）
- pinned（bool）
- archived（bool）
- tags[]（可选）
- created_at / updated_at

### 8.2 Expense

- expense_id, project_id
- date, amount, category?, note
- status: missing_receipt | matched | no_receipt_required
- receipt_ids[]（0..n）
- created_at / updated_at

### 8.3 Receipt

- receipt_id, project_id
- file_url, file_type, hash, uploaded_at
- merchant_keyword?
- receipt_type?（交通/餐饮/其他，可选）
- matched_expense_id?（默认一对一）
- receipt_amount?, receipt_date?


### 8.4 Batch

- batch_id, project_id, name
- filter_json（日期范围/状态/类别）
- created_at
- export_records[]（格式、时间、文件路径）

---

## 9. 验收标准（Acceptance Criteria）

### MUST

1. 新增支出必须挂项目；默认进入上次项目，能一键录入。
2. 票据支持多选上传并在收纳箱预览。
3. OCR 开启时，至少 60% 常见电子票据/截图能提取到“金额或日期之一”（失败不影响主流程）。
4. 候选匹配在票据卡片展示 Top 3；点击确认才绑定；忽略不绑定。
5. 批次检查必须列出：缺票、重复（hash 相同）、金额不一致（当 OCR/手填存在）。
6. 导出 CSV 与 ZIP：ZIP 文件命名与 CSV 序号一致，可追溯。

### SHOULD

7. 新增支出（金额+备注）到列表出现路径 ≤ 3 步。
8. 票据匹配操作 ≤ 2 步（建议一键确认或手动搜索选择）。

---
