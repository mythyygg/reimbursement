# Supabase 数据库性能测试工具

## 快速使用

### 方法 1: 使用快捷脚本
```bash
cd apps/api
./test-db-speed.sh
```

### 方法 2: 直接运行 TypeScript
```bash
cd apps/api
npx tsx src/scripts/test-db-performance.ts
```

## 测试内容

脚本会执行以下 8 种数据库操作测试：

1. **网络往返时间 (RTT)** - `SELECT 1`
   - 测试纯网络延迟，无数据库处理开销
   - 多次执行：20 轮

2. **简单查询** - 单表单条记录
   - `SELECT * FROM projects LIMIT 1`
   - 多次执行：15 轮

3. **列表查询** - 单表多条记录
   - `SELECT * FROM projects LIMIT 20`
   - 多次执行：15 轮

4. **COUNT 聚合查询**
   - `SELECT COUNT(*) FROM projects`
   - 多次执行：15 轮

5. **条件查询** - WHERE + LIMIT
   - `SELECT * FROM projects WHERE archived = false LIMIT 10`
   - 多次执行：15 轮

6. **排序查询** - ORDER BY
   - `SELECT * FROM expenses ORDER BY date DESC LIMIT 20`
   - 多次执行：15 轮

7. **JOIN 查询** - LEFT JOIN + GROUP BY
   - 项目和票据的关联查询
   - 多次执行：10 轮

8. **复杂查询** - 多条件 + 排序 + 分页
   - 综合查询性能测试
   - 多次执行：10 轮

## 输出示例

```
🚀 Supabase 数据库性能测试
================================================================================

测试环境信息:
   数据库: aws-0-ap-southeast-1.pooler.supabase.com
   时间: 2025-12-28 15:30:45

🧪 测试: 1. 网络往返时间 (SELECT 1)
   执行 20 次...
   [1/20] 145ms [2/20] 132ms [3/20] 128ms ...

================================================================================
📊 测试结果汇总
================================================================================

测试项目                          平均耗时    最小    最大    P95
--------------------------------------------------------------------------------
1. 网络往返时间 (SELECT 1)           134ms    121ms   156ms   148ms
2. 简单查询 (单表单条)                142ms    128ms   167ms   159ms
3. 列表查询 (单表多条)                156ms    139ms   189ms   178ms
4. COUNT 聚合查询                    145ms    131ms   168ms   162ms
5. 条件查询 (WHERE + LIMIT)          151ms    136ms   179ms   171ms
6. 排序查询 (ORDER BY)               168ms    147ms   203ms   195ms
7. JOIN 查询 (LEFT JOIN)             234ms    198ms   289ms   267ms
8. 复杂查询 (多表多条件)              189ms    165ms   234ms   221ms
--------------------------------------------------------------------------------

💡 性能评估:

   ⚠️  网络延迟: 一般 (100-200ms)
   ⚡ 查询性能: 良好 (100-300ms)

📌 说明:
   - RTT (往返时间) 主要反映网络延迟
   - 简单查询性能应接近 RTT
   - 复杂查询性能 = RTT + 数据库处理时间
   - P95 表示 95% 的请求在该时间内完成

✅ 测试完成!
```

## 性能标准

### 网络延迟 (RTT)
- ✅ **优秀**: < 50ms (同区域或CDN加速)
- ⚡ **良好**: 50-100ms (邻近区域)
- ⚠️ **一般**: 100-200ms (跨区域)
- ❌ **较慢**: > 200ms (跨大洲，建议使用更近的区域)

### 查询性能
- ✅ **优秀**: < 100ms
- ⚡ **良好**: 100-300ms
- ⚠️ **一般**: 300-500ms
- ❌ **较慢**: > 500ms (需要优化查询或添加索引)

## 常见问题

### Q: 为什么所有查询都很慢？
A: 如果 RTT 就很高（>200ms），说明主要是网络延迟问题。考虑：
   1. 使用离用户更近的 Supabase 区域
   2. 使用 Connection Pooler (已启用)
   3. 考虑使用 Cloudflare Workers 等边缘计算

### Q: RTT 正常但查询慢？
A: 可能是查询本身的问题：
   1. 检查是否缺少索引
   2. 优化查询逻辑（减少 JOIN、使用分页）
   3. 查看 Supabase 控制台的查询性能分析

### Q: 如何解读 P95 指标？
A: P95 表示 95% 的请求在该时间内完成。
   例如 P95=200ms 意味着只有 5% 的请求超过 200ms。
   这比平均值更能反映用户实际体验。

## 注意事项

- 测试会执行真实的数据库查询，请确保有测试数据
- 如果数据库为空，某些测试可能返回空结果（不影响性能测量）
- 建议在不同时间段多次运行，观察延迟变化
- 测试结果受网络状况影响，偶尔的高延迟是正常的
